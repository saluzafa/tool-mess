<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <title>OpenAI Token Price Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind v4-compatible CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind config: enable class-based dark mode
    tailwind.config = {
      darkMode: 'class'
    };
  </script>

  <style>
    /* Small utility for smooth theme transitions */
    html {
      transition: color 0.2s ease, background-color 0.2s ease;
    }
  </style>
</head>
<body class="h-full bg-slate-100 text-slate-900 dark:bg-slate-900 dark:text-slate-100">
  <div class="min-h-full">
    <header class="border-b border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-950/80 backdrop-blur">
      <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between gap-4">
        <div>
          <h1 class="text-xl sm:text-2xl font-semibold tracking-tight">
            OpenAI Token Price Calculator
          </h1>
          <p class="text-xs sm:text-sm text-slate-500 dark:text-slate-400">
            Prices per <span class="font-mono">1M</span> tokens ¬∑ Standard tier ¬∑ Live cost estimation
          </p>
        </div>

        <div class="flex items-center gap-2">
          <!-- Theme toggle -->
          <button id="themeToggle"
                  type="button"
                  class="inline-flex items-center gap-1 rounded-lg border border-slate-300 dark:border-slate-700 px-3 py-1.5 text-xs font-medium shadow-sm bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800">
            <span id="themeIcon" aria-hidden="true">üåô</span>
            <span id="themeLabel">Dark</span>
          </button>

          <!-- Share button -->
          <button id="shareButton"
                  type="button"
                  class="inline-flex items-center gap-1 rounded-lg border border-indigo-500 px-3 py-1.5 text-xs font-semibold shadow-sm bg-indigo-600 text-white hover:bg-indigo-500">
            <span>Share</span>
          </button>
        </div>
      </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">
      <!-- Info -->
      <section class="text-xs sm:text-sm text-slate-500 dark:text-slate-400 space-y-1">
        <p>
          Each row below is an ‚Äúexpense line‚Äù for one model call. Enter token counts and the calculator will compute
          the cost using OpenAI‚Äôs current pricing (Standard, text tokens, per 1M tokens).
        </p>
        <p>
          The full configuration (rows + values + theme) is stored in the URL so you can copy it and share with others.
        </p>
      </section>

      <!-- Expenses Card -->
      <section class="bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-2xl shadow-sm">
        <div class="px-4 sm:px-6 py-4 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between gap-3">
          <div>
            <h2 class="text-sm sm:text-base font-semibold">
              Expenses
            </h2>
            <p class="text-xs text-slate-500 dark:text-slate-400">
              Add one line per distinct call pattern / workload.
            </p>
          </div>

          <button id="addRowButton"
                  type="button"
                  class="inline-flex items-center gap-1 rounded-lg border border-emerald-500 px-3 py-1.5 text-xs font-semibold shadow-sm bg-emerald-600 text-white hover:bg-emerald-500">
            <span>+ Add row</span>
          </button>
        </div>

        <!-- Table-ish header -->
        <div class="hidden md:grid grid-cols-[minmax(0,2.2fr)_repeat(3,minmax(0,1.1fr))_minmax(0,1.2fr)_auto] gap-3 px-4 sm:px-6 py-3 text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400 border-b border-slate-100 dark:border-slate-800">
          <div>Model</div>
          <div class="text-right">Input tokens</div>
          <div class="text-right">Cached input</div>
          <div class="text-right">Output tokens</div>
          <div class="text-right">Row total</div>
          <div class="text-right">Actions</div>
        </div>

        <!-- Rows container -->
        <div id="expensesContainer" class="divide-y divide-slate-100 dark:divide-slate-800">
          <!-- rows injected here -->
        </div>

        <!-- Summary -->
        <div class="px-4 sm:px-6 py-4 sm:py-5 border-t border-slate-100 dark:border-slate-800">
          <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4 text-xs sm:text-sm">
            <div class="bg-slate-50 dark:bg-slate-900/60 rounded-xl px-3 py-2.5">
              <div class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">
                Total input cost
              </div>
              <div id="totalInputCost" class="mt-1 text-base font-semibold tabular-nums">
                $0.000000
              </div>
            </div>

            <div class="bg-slate-50 dark:bg-slate-900/60 rounded-xl px-3 py-2.5">
              <div class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">
                Total cached input cost
              </div>
              <div id="totalCachedCost" class="mt-1 text-base font-semibold tabular-nums">
                $0.000000
              </div>
            </div>

            <div class="bg-slate-50 dark:bg-slate-900/60 rounded-xl px-3 py-2.5">
              <div class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">
                Total output cost
              </div>
              <div id="totalOutputCost" class="mt-1 text-base font-semibold tabular-nums">
                $0.000000
              </div>
            </div>

            <div class="bg-indigo-50 dark:bg-indigo-950/40 rounded-xl px-3 py-2.5">
              <div class="text-[11px] uppercase tracking-wide text-indigo-700 dark:text-indigo-200">
                Grand total
              </div>
              <div id="grandTotalCost" class="mt-1 text-lg font-bold tabular-nums text-indigo-700 dark:text-indigo-200">
                $0.000000
              </div>
            </div>
          </div>

          <!-- Token totals -->
          <div class="mt-3 flex flex-wrap gap-3 text-[11px] sm:text-xs text-slate-500 dark:text-slate-400">
            <div>
              <span class="font-semibold">Total tokens:</span>
              <span id="totalTokens">0</span>
            </div>
            <div>
              <span class="font-semibold">Input:</span>
              <span id="totalInputTokens">0</span>
            </div>
            <div>
              <span class="font-semibold">Cached input:</span>
              <span id="totalCachedTokens">0</span>
            </div>
            <div>
              <span class="font-semibold">Output:</span>
              <span id="totalOutputTokens">0</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Footnote -->
      <section class="text-[11px] sm:text-xs text-slate-400 dark:text-slate-500 space-y-1">
        <p>
          Prices are pulled from OpenAI‚Äôs
          <a href="https://platform.openai.com/docs/pricing" class="underline hover:text-indigo-500" target="_blank" rel="noreferrer">
            official pricing page
          </a>
          (Standard ¬∑ text tokens ¬∑ per 1M tokens). Always double-check in case OpenAI updates their pricing.
        </p>
      </section>
    </main>
  </div>

  <script>
    /*************************************************
     * Pricing data (Standard tier, text tokens, $/1M)
     * Source: https://platform.openai.com/docs/pricing
     *************************************************/
    const MODEL_PRICING = {
      // GPT-5.x family
      "gpt-5.2":              { input: 1.75,  cached: 0.175,  output: 14.00 },
      "gpt-5.1":              { input: 1.25,  cached: 0.125,  output: 10.00 },
      "gpt-5":                { input: 1.25,  cached: 0.125,  output: 10.00 },
      "gpt-5-mini":           { input: 0.25,  cached: 0.025,  output: 2.00  },
      "gpt-5-nano":           { input: 0.05,  cached: 0.005,  output: 0.40 },

      "gpt-5.2-chat-latest":  { input: 1.75,  cached: 0.175,  output: 14.00 },
      "gpt-5.1-chat-latest":  { input: 1.25,  cached: 0.125,  output: 10.00 },
      "gpt-5-chat-latest":    { input: 1.25,  cached: 0.125,  output: 10.00 },

      "gpt-5.1-codex-max":    { input: 1.25,  cached: 0.125,  output: 10.00 },
      "gpt-5.1-codex":        { input: 1.25,  cached: 0.125,  output: 10.00 },
      "gpt-5-codex":          { input: 1.25,  cached: 0.125,  output: 10.00 },
      "gpt-5.1-codex-mini":   { input: 0.25,  cached: 0.025,  output: 2.00  },

      "gpt-5-search-api":     { input: 1.25,  cached: 0.125,  output: 10.00 },

      // GPT-4.1 / 4o etc.
      "gpt-4.1":              { input: 2.00,  cached: 0.50,   output: 8.00  },
      "gpt-4.1-mini":         { input: 0.40,  cached: 0.10,   output: 1.60  },
      "gpt-4.1-nano":         { input: 0.10,  cached: 0.025,  output: 0.40  },

      "gpt-4o":               { input: 2.50,  cached: 1.25,   output: 10.00 },
      "gpt-4o-mini":          { input: 0.15,  cached: 0.075,  output: 0.60  },

      // Realtime text tokens
      "gpt-realtime":                 { input: 4.00,  cached: 0.40,   output: 16.00 },
      "gpt-realtime-mini":            { input: 0.60,  cached: 0.06,   output: 2.40  },
      "gpt-4o-realtime-preview":      { input: 5.00,  cached: 2.50,   output: 20.00 },
      "gpt-4o-mini-realtime-preview": { input: 0.60,  cached: 0.30,   output: 2.40  },

      // o-series
      "o1":                   { input: 15.00, cached: 7.50,  output: 60.00 },
      "o1-mini":              { input: 1.10,  cached: 0.55,  output: 4.40  },
      "o3":                   { input: 2.00,  cached: 0.50,  output: 8.00  },
      "o3-mini":              { input: 1.10,  cached: 0.55,  output: 4.40  },
      "o3-deep-research":     { input: 10.00, cached: 2.50,  output: 40.00 },
      "o4-mini":              { input: 1.10,  cached: 0.275, output: 4.40  },
      "o4-mini-deep-research":{ input: 2.00,  cached: 0.50,  output: 8.00  },

      // Codex mini
      "codex-mini-latest":    { input: 1.50,  cached: 0.375, output: 6.00  },

      // Image models ‚Äì *text* tokens (not the image token section)
      "gpt-image-1.5":        { input: 5.00,  cached: 1.25,  output: 10.00 },
      "chatgpt-image-latest": { input: 5.00,  cached: 1.25,  output: 10.00 }
    };

    // Order models nicely (grouped-ish)
    const MODEL_ORDER = Object.keys(MODEL_PRICING).sort((a, b) => a.localeCompare(b));

    /**************************
     * Theme handling
     **************************/
    const THEME_KEY = "gpt-token-calc-theme"; // 'light' | 'dark' | 'system'

    function getSystemPrefersDark() {
      return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    }

    function applyTheme(theme) {
      const root = document.documentElement;
      let effective = theme;

      if (!theme || theme === 'system') {
        effective = getSystemPrefersDark() ? 'dark' : 'light';
      }

      if (effective === 'dark') {
        root.classList.add('dark');
      } else {
        root.classList.remove('dark');
      }

      const themeIcon = document.getElementById('themeIcon');
      const themeLabel = document.getElementById('themeLabel');
      if (themeIcon && themeLabel) {
        if (effective === 'dark') {
          themeIcon.textContent = 'üåô';
          themeLabel.textContent = 'Dark';
        } else {
          themeIcon.textContent = '‚òÄÔ∏è';
          themeLabel.textContent = 'Light';
        }
      }
    }

    function loadInitialTheme() {
      const stored = localStorage.getItem(THEME_KEY);
      if (stored) {
        applyTheme(stored);
      } else {
        applyTheme('system');
      }
    }

    function toggleTheme() {
      // Toggle between light and dark, but treat "system" as dark/light based on system
      const root = document.documentElement;
      const isCurrentlyDark = root.classList.contains('dark');
      const nextTheme = isCurrentlyDark ? 'light' : 'dark';
      localStorage.setItem(THEME_KEY, nextTheme);
      applyTheme(nextTheme);
      updateURLState(); // include theme in shared URL
    }

    /**************************
     * Row state & URL sharing
     **************************/
    const expensesContainer = document.getElementById('expensesContainer');
    const addRowButton = document.getElementById('addRowButton');
    const shareButton = document.getElementById('shareButton');
    const themeToggle = document.getElementById('themeToggle');

    const totalInputCostEl = document.getElementById('totalInputCost');
    const totalCachedCostEl = document.getElementById('totalCachedCost');
    const totalOutputCostEl = document.getElementById('totalOutputCost');
    const grandTotalCostEl = document.getElementById('grandTotalCost');

    const totalTokensEl = document.getElementById('totalTokens');
    const totalInputTokensEl = document.getElementById('totalInputTokens');
    const totalCachedTokensEl = document.getElementById('totalCachedTokens');
    const totalOutputTokensEl = document.getElementById('totalOutputTokens');

    // Internal representation of rows (array of objects with DOM refs)
    const rows = [];

    function formatMoney(num) {
      return '$' + num.toFixed(6);
    }

    function parseNumber(value) {
      const n = Number(value);
      return Number.isFinite(n) ? n : 0;
    }

    function createModelSelect() {
      const select = document.createElement('select');
      select.className = "block w-full rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-xs sm:text-sm px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-indigo-500";

      MODEL_ORDER.forEach(modelName => {
        const pricing = MODEL_PRICING[modelName];
        const option = document.createElement('option');
        option.value = modelName;
        option.textContent = `${modelName} ($${pricing.input}/$${pricing.output} per 1M in/out)`;
        select.appendChild(option);
      });

      return select;
    }

    function createNumberInput(placeholder) {
      const input = document.createElement('input');
      input.type = 'number';
      input.min = '0';
      input.step = '1';
      input.placeholder = placeholder || '0';
      input.className = "block w-full rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-right text-xs sm:text-sm px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-indigo-500 tabular-nums";
      return input;
    }

    function createExpenseRow(initial = {}) {
      const rowWrapper = document.createElement('div');
      rowWrapper.className = "px-4 sm:px-6 py-3";

      // Responsive layout: stack on mobile, table-like on desktop
      const inner = document.createElement('div');
      inner.className = "grid gap-3 md:grid-cols-[minmax(0,2.2fr)_repeat(3,minmax(0,1.1fr))_minmax(0,1.2fr)_auto] md:items-center";

      // Model select
      const modelCell = document.createElement('div');
      const modelLabelMobile = document.createElement('div');
      modelLabelMobile.className = "md:hidden text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-1";
      modelLabelMobile.textContent = "Model";
      modelCell.appendChild(modelLabelMobile);
      const modelSelect = createModelSelect();
      modelCell.appendChild(modelSelect);

      // Input tokens
      const inputCell = document.createElement('div');
      inputCell.className = "md:text-right";
      const inputLabelMobile = document.createElement('div');
      inputLabelMobile.className = "md:hidden text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-1";
      inputLabelMobile.textContent = "Input tokens";
      const inputInput = createNumberInput('0');
      inputCell.appendChild(inputLabelMobile);
      inputCell.appendChild(inputInput);

      // Cached input
      const cachedCell = document.createElement('div');
      cachedCell.className = "md:text-right";
      const cachedLabelMobile = document.createElement('div');
      cachedLabelMobile.className = "md:hidden text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-1";
      cachedLabelMobile.textContent = "Cached input tokens";
      const cachedInput = createNumberInput('0');
      cachedInput.value = initial.cachedTokens || 0;
      cachedCell.appendChild(cachedLabelMobile);
      cachedCell.appendChild(cachedInput);

      // Output tokens
      const outputCell = document.createElement('div');
      outputCell.className = "md:text-right";
      const outputLabelMobile = document.createElement('div');
      outputLabelMobile.className = "md:hidden text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-1";
      outputLabelMobile.textContent = "Output tokens";
      const outputInput = createNumberInput('0');
      outputCell.appendChild(outputLabelMobile);
      outputCell.appendChild(outputInput);

      // Row total
      const totalCell = document.createElement('div');
      totalCell.className = "flex md:block items-center justify-between gap-2";
      const totalLabelMobile = document.createElement('div');
      totalLabelMobile.className = "md:hidden text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400";
      totalLabelMobile.textContent = "Row total";
      const totalValue = document.createElement('div');
      totalValue.className = "ml-auto md:ml-0 text-right text-xs sm:text-sm font-semibold tabular-nums text-slate-800 dark:text-slate-100";
      totalValue.textContent = "$0.000000";
      totalCell.appendChild(totalLabelMobile);
      totalCell.appendChild(totalValue);

      // Remove
      const actionsCell = document.createElement('div');
      actionsCell.className = "flex justify-end md:justify-end";
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = "inline-flex items-center rounded-md border border-red-300 dark:border-red-700 px-2 py-1 text-[11px] sm:text-xs font-medium text-red-700 dark:text-red-200 bg-white dark:bg-slate-900 hover:bg-red-50 dark:hover:bg-red-900/40";
      removeBtn.textContent = "Remove";
      actionsCell.appendChild(removeBtn);

      // Assemble inner grid
      inner.appendChild(modelCell);
      inner.appendChild(inputCell);
      inner.appendChild(cachedCell);
      inner.appendChild(outputCell);
      inner.appendChild(totalCell);
      inner.appendChild(actionsCell);

      rowWrapper.appendChild(inner);
      expensesContainer.appendChild(rowWrapper);

      // Determine default model
      const defaultModel = initial.model && MODEL_PRICING[initial.model]
        ? initial.model
        : (MODEL_PRICING["gpt-5.2"] ? "gpt-5.2" : MODEL_ORDER[0]);

      modelSelect.value = defaultModel;
      if (initial.inputTokens != null) inputInput.value = initial.inputTokens;
      if (initial.cachedTokens != null) cachedInput.value = initial.cachedTokens;
      if (initial.outputTokens != null) outputInput.value = initial.outputTokens;

      const rowState = {
        root: rowWrapper,
        modelSelect,
        inputInput,
        cachedInput,
        outputInput,
        totalValue,
      };

      rows.push(rowState);

      // Event handlers: recalc + update URL
      const onChange = () => {
        recalculateAll();
        updateURLState();
      };

      modelSelect.addEventListener('change', onChange);
      inputInput.addEventListener('input', onChange);
      cachedInput.addEventListener('input', onChange);
      outputInput.addEventListener('input', onChange);

      removeBtn.addEventListener('click', () => {
        const idx = rows.indexOf(rowState);
        if (idx !== -1) {
          rows.splice(idx, 1);
        }
        rowWrapper.remove();
        recalculateAll();
        updateURLState();
        if (rows.length === 0) {
          // Always keep at least one empty row
          createExpenseRow();
        }
      });

      recalculateAll();
      updateURLState();
    }

    function recalculateAll() {
      let totalInputCost = 0;
      let totalCachedCost = 0;
      let totalOutputCost = 0;

      let totalInputTokens = 0;
      let totalCachedTokens = 0;
      let totalOutputTokens = 0;

      rows.forEach(row => {
        const modelName = row.modelSelect.value;
        const pricing = MODEL_PRICING[modelName];
        if (!pricing) return;

        const inputTokens = parseNumber(row.inputInput.value);
        const cachedTokens = parseNumber(row.cachedInput.value);
        const outputTokens = parseNumber(row.outputInput.value);

        totalInputTokens += inputTokens;
        totalCachedTokens += cachedTokens;
        totalOutputTokens += outputTokens;

        const inputCost = pricing.input * (inputTokens / 1_000_000);
        const cachedCost = pricing.cached * (cachedTokens / 1_000_000);
        const outputCost = pricing.output * (outputTokens / 1_000_000);
        const rowTotal = inputCost + cachedCost + outputCost;

        totalInputCost += inputCost;
        totalCachedCost += cachedCost;
        totalOutputCost += outputCost;

        row.totalValue.textContent = formatMoney(rowTotal);
      });

      const grandTotal = totalInputCost + totalCachedCost + totalOutputCost;

      totalInputCostEl.textContent = formatMoney(totalInputCost);
      totalCachedCostEl.textContent = formatMoney(totalCachedCost);
      totalOutputCostEl.textContent = formatMoney(totalOutputCost);
      grandTotalCostEl.textContent = formatMoney(grandTotal);

      const totalTokens = totalInputTokens + totalCachedTokens + totalOutputTokens;
      totalTokensEl.textContent = totalTokens.toLocaleString();
      totalInputTokensEl.textContent = totalInputTokens.toLocaleString();
      totalCachedTokensEl.textContent = totalCachedTokens.toLocaleString();
      totalOutputTokensEl.textContent = totalOutputTokens.toLocaleString();
    }

    /**************************
     * URL state encoding
     **************************/
    function getCurrentThemeSetting() {
      const stored = localStorage.getItem(THEME_KEY);
      if (stored) return stored;
      // if not stored, treat as 'system'
      return 'system';
    }

    function serializeState() {
      const rowData = rows.map(row => ({
        m: row.modelSelect.value,
        i: parseNumber(row.inputInput.value),
        c: parseNumber(row.cachedInput.value),
        o: parseNumber(row.outputInput.value)
      }));

      return {
        t: getCurrentThemeSetting(),
        r: rowData
      };
    }

    function encodeState(stateObj) {
      try {
        const json = JSON.stringify(stateObj);
        return btoa(encodeURIComponent(json)); // URI-safe
      } catch (e) {
        console.error("Failed to encode state", e);
        return null;
      }
    }

    function decodeState(encoded) {
      try {
        const json = decodeURIComponent(atob(encoded));
        const obj = JSON.parse(json);
        if (!obj || typeof obj !== 'object') return null;
        if (!Array.isArray(obj.r)) return null;
        return obj;
      } catch (e) {
        console.warn("Failed to decode state from URL", e);
        return null;
      }
    }

    function updateURLState() {
      const state = serializeState();
      const encoded = encodeState(state);
      const url = new URL(window.location.href);

      if (encoded && state.r.length > 0) {
        url.searchParams.set('state', encoded);
      } else {
        url.searchParams.delete('state');
      }

      window.history.replaceState({}, '', url.toString());
    }

    function loadStateFromURL() {
      const url = new URL(window.location.href);
      const encoded = url.searchParams.get('state');
      if (!encoded) return null;

      const state = decodeState(encoded);
      return state;
    }

    function applyLoadedState(state) {
      // Clear any existing rows
      rows.splice(0, rows.length);
      expensesContainer.innerHTML = '';

      // Theme
      if (state.t) {
        localStorage.setItem(THEME_KEY, state.t);
        applyTheme(state.t);
      }

      if (!Array.isArray(state.r) || state.r.length === 0) {
        createExpenseRow();
        return;
      }

      state.r.forEach(r => {
        const model = MODEL_PRICING[r.m] ? r.m : undefined;
        createExpenseRow({
          model,
          inputTokens: typeof r.i === 'number' ? r.i : 0,
          cachedTokens: typeof r.c === 'number' ? r.c : 0,
          outputTokens: typeof r.o === 'number' ? r.o : 0
        });
      });

      recalculateAll();
    }

    /**************************
     * Share button
     **************************/
    async function handleShareClick() {
      // Ensure URL is up-to-date with latest state
      updateURLState();
      const url = window.location.href;

      // Try Web Share API first (mobile-friendly)
      if (navigator.share) {
        try {
          await navigator.share({
            title: 'OpenAI Token Price Calculator',
            text: 'Here is a token cost breakdown using OpenAI‚Äôs latest pricing.',
            url
          });
          return;
        } catch (err) {
          // User cancelled or share not available; fall back to clipboard.
          console.warn('Share via navigator.share failed, falling back to clipboard', err);
        }
      }

      // Clipboard fallback
      if (navigator.clipboard && navigator.clipboard.writeText) {
        try {
          await navigator.clipboard.writeText(url);
          shareButton.textContent = 'Copied!';
          setTimeout(() => (shareButton.textContent = 'Share'), 1500);
          return;
        } catch (err) {
          console.error('Failed to copy URL to clipboard', err);
        }
      }

      // Ultimate fallback: prompt
      window.prompt('Copy this URL:', url);
    }

    /**************************
     * Init
     **************************/
    document.addEventListener('DOMContentLoaded', () => {
      // Theme first (before painting)
      loadInitialTheme();

      // Load from URL if present
      const loaded = loadStateFromURL();
      if (loaded) {
        applyLoadedState(loaded);
      } else {
        // At least one default row
        createExpenseRow();
      }

      // Hook buttons
      addRowButton.addEventListener('click', () => {
        createExpenseRow();
      });

      shareButton.addEventListener('click', handleShareClick);
      themeToggle.addEventListener('click', toggleTheme);
    });
  </script>
</body>
</html>
